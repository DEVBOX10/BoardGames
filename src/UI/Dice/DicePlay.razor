@attribute [MatchFor(typeof(DiceEngine), ComponentScopes.GamePlay)]
@using Stl.Time
@inherits GamePlayBase

@{
    var gameEngine = (DiceEngine) GameEngine;
    var gameState = gameEngine.DeserializeState(Game.StateJson);
    var board = gameState.Board;
}

<WhenCommandError Exception="CommandRunner.Error"/>

@if (Game.Stage != GameStage.Ended) {
    <Paragraph>
        <GameMessage Message="@Game.StateMessage" Players="Game.Players" Users="Users"/>
        <hr>

        <Button Color="@GetDiceColor(gameState.PlayerIndex)"
                Style="align-content: center; border-radius: 3px;"
                disabled="@(gameState.PlayerIndex != MyPlayerIndex)"
                @onclick="_ => MoveAsync()">
            Drop Dice
        </Button>
        <Button Color="Color.Primary" Style="align-content: center; border: 1px solid darkblue;" disabled>@diceValue</Button>
        <button type="button" class="btn btn-custom" disabled>My color</button>
        <button type="button" class="btn btn-forward" disabled>+3 steps</button>
        <button type="button" class="btn btn-backward" disabled>-3 steps</button>

    </Paragraph>
}

<Row><Column ColumnSize="ColumnSize.Is6">
    <table><tbody>
        @for (var r = 0; r < DiceEngine.BoardSize; r++) {
            var row = r;
            <tr @key=@row>
                @if (r % 2 == 0)
                {
                    @for (var c = 0; c < DiceEngine.BoardSize; c++)
                    {
                        var col = c;
                        var cell = board[row, col];
                        <td @key=@((row, col))>
                            <table style="margin: 1px; min-width: 50px; min-height: 50px; background: @GetCellBackground(cell);">
                                <tbody>
                                <tr>
                                    <td align="center">
                                        <div align="center">
                                            <i class="fas fa-circle" style="opacity: @cell[0]; color: blue;"></i>
                                        </div>
                                    </td>
                                    <td align="center">
                                        <div align="center">
                                            <i class="fas fa-circle" style="opacity: @cell[1]; color: green;"></i>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td align="center">
                                        <div align="center">
                                            <i class="fas fa-circle" style="opacity: @cell[2]; color: red;"></i>
                                        </div>
                                    </td>
                                    <td align="center">
                                        <div align="center">
                                            <i class="fas fa-circle" style="opacity: @cell[3]; color: yellow;"></i>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </td>
                    }
                }
                else
                {
                    @for (var c = DiceEngine.BoardSize - 1; c >= 0; c--)
                    {
                        var col = c;
                        var cell = board[row, col];
                        <td @key=@((row, col))>
                            <table style="margin: 1px; min-width: 50px; min-height: 50px; background: @GetCellBackground(cell);">
                                <tbody>
                                <tr>
                                    <td align="center">
                                        <div align="center">
                                            <i class="fas fa-circle" style="opacity: @cell[0]; color: blue;"></i>
                                        </div>
                                    </td>
                                    <td align="center">
                                        <div align="center">
                                            <i class="fas fa-circle" style="opacity: @cell[1]; color: green;"></i>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td align="center">
                                        <div align="center">
                                            <i class="fas fa-circle" style="opacity: @cell[2]; color: red;"></i>
                                        </div>
                                    </td>
                                    <td align="center">
                                        <div align="center">
                                            <i class="fas fa-circle" style="opacity: @cell[3]; color: yellow;"></i>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </td>
                    }
                }
            </tr>
        }
        </tbody></table>
</Column>
</Row>

@code {
    private int diceValue;

    private Task MoveAsync()
    {
        diceValue = GetRandomDigit();
        var move = new DiceMove(MyPlayerIndex, diceValue);
        var command = new Game.MoveCommand(Session, Game.Id, move);
        return CommandRunner.CallAsync(command);
    }

    private Color GetDiceColor(int playerIndex)
        => playerIndex == MyPlayerIndex ? Color.Success : Color.Danger;

    private int GetRandomDigit()
    {
        var rnd = new Random();
        return rnd.Next(1, 7);
    }

    private Dictionary<int, string> Colors = new Dictionary<int, string>()
    {
        {0, "blue"},
        {1, "green"},
        {2, "red"},
        {3, "yellow"},
    };

    private string GetCellBackground(double[] cell)
    {
        if (cell[4] == 1)
            return "#DC381F";
        if (cell[4] == 2)
            return "#52D017";
        return "lightgoldenrodyellow";
    }
}

<style>
    .btn-custom {
        background: @Colors[MyPlayerIndex];
        color: white;
        margin-left: 5px;
    }
    .btn-custom:hover{
        background: @Colors[MyPlayerIndex];
        color: white;
        opacity: 1;
    }
    .btn-custom:disabled{
        opacity: 1;
    }
    .btn-forward {
        background: #52D017;
        color: white;
        opacity: 1;
    }
    .btn-forward:hover{
        background: #52D017;
        color: white;
        opacity: 1;
    }
    .btn-forward:disabled{
        opacity: 1;
    }
    .btn-backward {
        background: #DC381F;
        color: white;
        opacity: 1;
    }
    .btn-backward:hover{
        background: #DC381F;
        color: white;
        opacity: 1;
    }
    .btn-backward:disabled{
        opacity: 1;
    }
</style>
